<!DOCTYPE html>
<html>

<body>

  <script>
    console.log(Math.random())

    function getComponent(name) {
      return components.find(c => c.name == name);
    }

    let components = [
      {
        name: "emptyComponent"
      },
      {
        name: "rectangleComponent",
        fillColor: "gray",
        x: 0, y: 0, rx: 1, ry: 1,
        draw() {
          $$.fi(this.fillColor).fillRectCentered(this.x, this.y, this.rx, this.ry)
        },
      },
      {
        name: "UITextComponent",
        text: "[Undefined]",
        fillColor: "green",
        font: "40px Arial",
        x: 10, y: 10,
        drawUI() {
          $$.fi(this.fillColor).fo(this.font).tc(this.text, c.canvas.width/2, c.canvas.height/2)
        },
      },
      {
        name: "mcpComponent",
        start() {
          //Set options for ps
          o.drawGrid = true;
          o.drawGridInFront = true
          o.fillColor = "cyan"
          o.disableCameraMovement = true;
          zoom(10).lookAt(0, 5);

          this.state = "playing"
          this.deathTimeout = 0;
          this.maxDeathTimeout = 1;
          this.timeBetweenPipes = 3;
          this.lastPipeTime = this.timeBetweenPipes;
          this.pipeSpawnX = 5
          this.pipeOpening = 4
          this.pipeRadius = .5
          this.inCollision = false;
          this.speed = 1
          this.previousPipes = 0 //How many pipes have we removed
        },
        update() {
          let bird = findGameObject("birdPrefab");
          let birdRectangle = bird.components[0];
          if (!bird) return;
          if (this.state && this.state != "playing") {
            this.deathTimeout += o.secondsBetweenFrames;
            if (this.deathTimeout > this.maxDeathTimeout) {
              changeScene(0)
            }
            else {
              let percent = Math.min(1, 2 * this.deathTimeout / (1 * this.maxDeathTimeout))
              zoom(interp(percent, 10, 1))
                .lookAt(bird.x, interp(percent, 5, bird.y))
            }
            return
          }

          let birdX = birdRectangle.x;
          this.lastPipeTime += o.secondsBetweenFrames;
          if (this.lastPipeTime >= this.timeBetweenPipes) {
            this.lastPipeTime = 0;
            let middle = Math.random() * 6 + 2;
            let gap = 4;
            this.addPipes(middle, gap, this.pipeSpawnX + birdX)
          }

          //Now check for collisions
          this.inCollision = false
          for (const pipe of findGameObjects("pipe")) {
            if (collisionRectRect(bird.x, bird.y, bird.r, bird.r, pipe.x, pipe.y, pipe.rx, pipe.ry)) {
              this.inCollision = true
              this.state = "dying"
            }
          }

        },
        addPipes(middle, gap, x) {
          let pipe = Object.create(prefabs.find(p => p.name == "rectanglePrefab"))
          pipe.componentDefinitions[0].x = x;
          pipe.componentDefinitions[0].y = 10;
          pipe.componentDefinitions[0].rx = this.pipeRadius;
          pipe.componentDefinitions[0].ry = 10 - middle - gap / 2;
          pipe.componentDefinitions[0].fillColor = "green"
          getGameObjects().push(pipe)

          pipe = Object.create(prefabs.find(p => p.name == "rectanglePrefab"))
          pipe.componentDefinitions[0].x = x;
          // pipe.componentDefinitions[0].y = 0;
          // pipe.componentDefinitions[0].rx = this.pipeRadius;
          // pipe.componentDefinitions[0].ry = middle - gap / 2;
          // pipe.componentDefinitions[0].fillColor = "green"
          // getGameObjects().push(pipe)

        }
      },
      {
        name: "firstMCPComponent",
        start() {
          this.timer = 0;
        },
        update() {
          this.timer += o.secondsBetweenFrames;
          if (this.timer > 3) {
            changeScene(1)
          }
        },
      },
      {
        name: "pipeComponent",
        start() {
          this.x = this.startX;
          this.y = this.startY;
          this.rx = this.startRX;
          this.ry = this.startRY;
        }
      },
      {
        name: "birdComponent",
        start() {
          this.rectangle = this.gameObject.components[0]

          this.v = 0;
          this.r = .25;
          this.speed = 1;
        },
        update() {
          let mcp = findGameObject("mcpPrefab").components[0];
          if (!mcp) return;

          if (mcp.state && mcp.state != "playing")
            return

          this.v -= 9.8 * o.time; // Apply the downwad force of gravity
          i.down(" ", () => this.v = 5)
          this.rectangle.y += this.v * o.time;
          this.rectangle.x += o.time * this.speed;
          lookAt(this.rectangle.x, 5);

          if (this.rectangle.y - this.r <= 0 || this.rectangle.y + this.r >= 10) {
            //You hit the ground or the top
            mcp.state = "dying"
            mcp.inCollision = true;
          }
        }
      },

    ]

    let prefabs = [
      {
        name:"UITextPrefab",
        componentDefinitions:[
          {
            parent:"UITextComponent"
          }
        ]
      },
      {
        name: "birdPrefab",
        componentDefinitions: [
          {
            parent: "rectangleComponent",
            x: 0,
            y: 0,
            rx: 1,
            ry: 1,
          },
          {
            parent:"birdComponent",
          }
        ]
      },
      {
        name: "rectanglePrefab",
        componentDefinitions: [
          {
            parent: "rectangleComponent",
          }
        ]
      },
      {
        name: "firstMCPPrefab",
        componentDefinitions: [
          {
            parent: "firstMCPComponent",
          }
        ]
      },
      {
        name: "mcpPrefab",
        componentDefinitions: [
          {
            parent: "mcpComponent",
          }
        ]
      }
    ]

    let scenes = [
      {
        start() {
          //Essentially do what the Unity IDE is doing
          zoom(5)
          let UITextPrefab = prefabs.find(p => p.name == "UITextPrefab")
          UITextPrefab.componentDefinitions[0].text = "Welcome to the Game"
          let firstMCPPrefab = prefabs.find(p => p.name == "firstMCPPrefab")


          let UITextInstance = Object.create(UITextPrefab)
          let firstMCPInstance = Object.create(firstMCPPrefab)

          this.gameObjects = [firstMCPInstance, UITextInstance];
        },
      },
      {
        start() {
          let birdPrefab = prefabs.find(p => p.name == "birdPrefab")
          birdPrefab.componentDefinitions[0].fillColor = "blue"
          birdPrefab.componentDefinitions[0].y = 5
          birdPrefab.componentDefinitions[0].rx = .25
          birdPrefab.componentDefinitions[0].ry = .25
          let mcpPrefab = prefabs.find(p => p.name == "mcpPrefab")

          let birdInstance = Object.create(birdPrefab)
          let mcpInstance = Object.create(mcpPrefab)

          this.gameObjects = [birdInstance, mcpInstance];
        }
      }
    ]
  </script>
  <script src="./../game.js"></script>

</body>

</html>